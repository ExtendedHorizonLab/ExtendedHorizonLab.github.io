{{ define "main" }}
  <div class="container">
    <div class="page-layout">
      <!-- Left Sidebar with Years -->
      <aside class="sidebar">
        <ul class="year-nav" id="year-nav">
          {{ $years := slice }}
          {{ range .Pages.ByDate.Reverse }}
            {{ $years = $years | append (.Date.Format "2006") }}
          {{ end }}
          {{ $uniqueYears := $years | uniq }}
          {{ range $i, $year := $uniqueYears }}
            <li{{ if eq $i 0 }} class="active"{{ end }}>
              <a href="#year-{{ $year }}">{{ $year }}</a>
            </li>
          {{ end }}
        </ul>
      </aside>

      <!-- Main Content -->
      <div class="main-content">
        <h1 class="page-title">Publications</h1>

        {{ $years := slice }}
        {{ range .Pages.ByDate.Reverse }}
          {{ $years = $years | append (.Date.Format "2006") }}
        {{ end }}
        {{ range $years | uniq }}
          {{ $year := . }}
          {{ $yearPubs := where $.Pages "Date.Year" (int $year) }}
          {{ with $yearPubs }}
          <div class="year-section" id="year-{{ $year }}">
            <h2 class="year-heading">{{ $year }}</h2>
            {{ range . }}
              <div class="pub-item">
                <div class="pub-thumb">
                  {{ with .Params.thumbnail }}
                  <img src="{{ . }}" alt="{{ $.Title }}">
                  {{ else }}
                  <div class="pub-thumb-placeholder"></div>
                  {{ end }}
                </div>
                <div class="pub-info">
                  <h3 class="pub-title">
                    <a href="{{ .RelPermalink }}">{{ .Title }}</a>
                    {{ with .Params.award_name }}
                    <span class="pub-award">{{ . }}</span>
                    {{ end }}
                  </h3>
                  <div class="pub-authors">
                    {{ $members := site.Data.labmembers.names }}
                    {{ range $i, $author := .Params.authors }}{{ if $i }}, {{ end }}{{ $person := site.GetPage (printf "/people/%s" ($author | urlize)) }}{{ if not $person }}{{ range where site.RegularPages "Section" "people" }}{{ if in .Params.alt_names $author }}{{ $person = . }}{{ end }}{{ end }}{{ end }}{{ if $person }}<a href="{{ $person.RelPermalink }}"><strong>{{ $author }}</strong></a>{{ else if in $members $author }}<strong>{{ $author }}</strong>{{ else }}{{ $author }}{{ end }}{{ end }}
                  </div>
                  <div class="pub-venue">{{ .Params.venue }}</div>
                  <div class="pub-links">
                    {{ with .Params.pdf }}<a href="{{ . }}" class="pub-link" target="_blank">pdf</a>{{ end }}
                    {{ with .Params.doi }}<a href="{{ . }}" class="pub-link" target="_blank">doi</a>{{ end }}
                    {{ with .Params.acm }}<a href="{{ . }}" class="pub-link" target="_blank">acm</a>{{ end }}
                    {{ with .Params.code }}<a href="{{ . }}" class="pub-link" target="_blank">code</a>{{ end }}
                    {{ with .Params.video }}<a href="{{ . }}" class="pub-link" target="_blank">video</a>{{ end }}
                    {{ with .Params.talk }}<a href="{{ . }}" class="pub-link" target="_blank">talk</a>{{ end }}
                  </div>
                </div>
              </div>
            {{ end }}
          </div>
          {{ end }}
        {{ end }}
      </div>
    </div>
  </div>

  <script>
    // Smooth scroll for year navigation
    document.querySelectorAll('.year-nav a').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);
        const target = document.getElementById(targetId);
        if (target) {
          const headerHeight = document.querySelector('header').offsetHeight;
          const y = target.getBoundingClientRect().top + window.pageYOffset - headerHeight - 16;
          window.scrollTo({ top: y, behavior: 'smooth' });
        }
        // Update active state
        document.querySelectorAll('.year-nav li').forEach(li => li.classList.remove('active'));
        this.parentElement.classList.add('active');
      });
    });

    // Update active year on scroll
    function updateActiveYear() {
      const headerHeight = document.querySelector('header').offsetHeight;
      const sections = document.querySelectorAll('.year-section');
      let current = '';
      sections.forEach(section => {
        const sectionTop = section.offsetTop;
        if (pageYOffset >= sectionTop - headerHeight - 32) {
          current = section.getAttribute('id');
        }
      });
      if (!current && sections.length) {
        current = sections[0].getAttribute('id');
      }
      document.querySelectorAll('.year-nav li').forEach(li => {
        li.classList.remove('active');
        if (li.querySelector('a').getAttribute('href') === '#' + current) {
          li.classList.add('active');
        }
      });
    }
    window.addEventListener('scroll', updateActiveYear);
    updateActiveYear();
  </script>
{{ end }}
